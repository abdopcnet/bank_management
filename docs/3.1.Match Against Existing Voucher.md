# Case 1: Match Against Existing Voucher

## Scenario 1A: One Bank Transaction matches One Payment Entry

**Example**:

-   ✅ You recorded: Payment Entry (Customer paid 1000, reference_no = CHQ-001)
-   ✅ Bank statement shows: Deposit 1000, reference_number = CHQ-001
-   ✅ Goal: Match Bank Transaction with existing Payment Entry

### Steps:

1. **Open Dialog**: Click "Actions" on the Bank Transaction (deposit 1000)

2. **Select Action**:

    - `action`: **"Match Against Voucher"** (default)

3. **Enable Document Type Filters**:

    - ☑ Check `payment_entry` (to search in Payment Entries)
    - ☑ Check `journal_entry` (if needed)
    - ☑ Check `exact_match` (optional - to show only exact amount matches)

4. **Wait for Search**:

    - System searches for matching vouchers
    - Function called: `get_linked_payments()`
    - Search criteria: Amount, Reference Number, Party, Date range

5. **Review Results in Table** (`payment_proposals`):

    - **If match found**: Table shows matching vouchers
        - Example row:
            - Document Type: Payment Entry
            - Document Name: ACC-PAY-00001 (clickable link)
            - Reference Date: 2024-01-15
            - Remaining: 1000
            - Reference Number: CHQ-001
            - Party: Customer Name
    - **If no match**: Shows "No Matching Vouchers Found"

6. **Select Voucher(s)**:

    - ☑ Check the checkbox next to the correct voucher

7. **Click "Reconcile"**:
    - Function called: `reconcile_vouchers()`
    - System links Bank Transaction with Payment Entry
    - Updates `allocated_amount` and `unallocated_amount`
    - Updates `clearance_date` in Payment Entry
    - **Result**: Transaction disappears from unreconciled list (if fully matched)

---

## Scenario 1B: One Bank Transaction matches Multiple Payment Entries

**Example**:

-   ✅ Bank statement shows: Deposit 2000, reference_number = 123123 (one check)
-   ✅ You recorded: Payment Entry 1 (1000, reference_no = 123123)
-   ✅ You recorded: Payment Entry 2 (1000, reference_no = 123123)
-   ✅ Goal: Match one Bank Transaction with two Payment Entries

### Steps:

1. **Open Dialog**: Click "Actions" on the Bank Transaction (deposit 2000)

2. **Select Action**:

    - `action`: **"Match Against Voucher"** (default)

3. **Enable Document Type Filters**:

    - ☑ Check `payment_entry`
    - ☐ Do NOT check `exact_match` (to see all matching vouchers regardless of amount)

4. **Wait for Search**:

    - System searches for all matching vouchers
    - Function called: `get_linked_payments()`
    - **Search finds**: Both Payment Entries with reference_no = 123123

5. **Review Results in Table** (`payment_proposals`):

    - **Table shows 2 rows**:
        - Row 1: Payment Entry 1, Remaining: 1000, Reference Number: 123123
        - Row 2: Payment Entry 2, Remaining: 1000, Reference Number: 123123

6. **Select Multiple Vouchers**:

    - ☑ Check checkbox for Payment Entry 1 (1000)
    - ☑ Check checkbox for Payment Entry 2 (1000)
    - **Total selected**: 2000 (matches Bank Transaction amount)

7. **Click "Reconcile"**:
    - Function called: `reconcile_vouchers()`
    - System links Bank Transaction with BOTH Payment Entries
    - Updates Bank Transaction:
        - `allocated_amount` = 2000 (1000 + 1000)
        - `unallocated_amount` = 0 (2000 - 2000)
        - `status` = Reconciled
    - Updates both Payment Entries:
        - Payment Entry 1: `clearance_date` = Bank Transaction date
        - Payment Entry 2: `clearance_date` = Bank Transaction date
    - **Result**: Bank Transaction disappears from unreconciled list (fully matched)

---

## Partial Matching Rules:

-   ✅ **Can match**: Multiple vouchers to one Bank Transaction
-   ✅ **Can match**: One voucher to multiple Bank Transactions (if amounts allow)
-   ✅ Total selected = Bank Transaction unallocated amount
-   ⚠️ Cannot exceed Bank Transaction amount
-   ⚠️ Each voucher matches once only

---

## Example: Bank Transaction with Partial Amount Matched

**Scenario**:

-   Bank Transaction: Deposit 2000, unallocated_amount = 2000
-   Payment Entry 1: 1000 (already matched with another Bank Transaction)
-   Payment Entry 2: 1500, reference_no = 123123

**In Table, you will see**:

-   Payment Entry 2: Remaining = 1500

**Select**:

-   Payment Entry 2: 1500
-   **Result**:
    -   `allocated_amount` = 1500
    -   `unallocated_amount` = 500 (2000 - 1500)
    -   Status remains Unreconciled (until fully matched)
